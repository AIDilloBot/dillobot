name: DilloBot Upstream Sync (Claude Code)

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no updates'
        required: false
        default: 'false'

env:
  UPSTREAM_REPO: openclaw/openclaw
  UPSTREAM_BRANCH: main

jobs:
  check-upstream:
    name: Check for Upstream Updates
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
      commit_count: ${{ steps.check.outputs.commit_count }}

    steps:
      - name: Checkout DilloBot
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || true
          git fetch upstream

      - name: Check for updates
        id: check
        run: |
          BEHIND=$(git rev-list --count HEAD..upstream/${{ env.UPSTREAM_BRANCH }} || echo "0")
          echo "commit_count=$BEHIND" >> $GITHUB_OUTPUT
          if [ "$BEHIND" -gt "0" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "üì¶ Found $BEHIND new commits from upstream"
            git log --oneline HEAD..upstream/${{ env.UPSTREAM_BRANCH }}
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Already up to date"
          fi

  sync-with-claude-code:
    name: Sync with Claude Code Analysis
    needs: check-upstream
    # DISABLED: Claude Code sync requires local execution with your subscription
    # The local-sync-reminder job will create an issue when updates are available
    # Run locally with: npm run dillobot:sync
    if: false  # Disabled - run sync locally instead
    runs-on: self-hosted

    steps:
      - name: Checkout DilloBot
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      # Option 1: For self-hosted runner (Claude Code already authenticated)
      - name: Verify Claude Code CLI
        id: claude-check
        run: |
          if command -v claude &> /dev/null; then
            echo "claude_available=true" >> $GITHUB_OUTPUT
            claude --version
          else
            echo "claude_available=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Claude Code CLI not found"
          fi

      # Option 2: For GitHub-hosted runner (inject credentials)
      # Uncomment if using credential injection instead of self-hosted runner
      # - name: Setup Claude Code CLI
      #   if: steps.claude-check.outputs.claude_available != 'true'
      #   env:
      #     CLAUDE_CODE_CREDENTIALS: ${{ secrets.CLAUDE_CODE_CREDENTIALS }}
      #   run: |
      #     npm install -g @anthropic-ai/claude-code
      #     mkdir -p ~/.claude
      #     echo "$CLAUDE_CODE_CREDENTIALS" > ~/.claude/credentials.json
      #     chmod 600 ~/.claude/credentials.json

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git || true
          git fetch upstream

      - name: Configure git
        run: |
          git config user.name "DilloBot Sync Agent"
          git config user.email "dillobot-sync@users.noreply.github.com"

      - name: Run Claude Code Sync Agent
        id: sync
        run: |
          npx ts-node scripts/sync/upstream-sync-agent.ts 2>&1 | tee sync-output.log
          EXIT_CODE=${PIPESTATUS[0]}

          if [ $EXIT_CODE -eq 0 ]; then
            echo "sync_status=success" >> $GITHUB_OUTPUT
          else
            echo "sync_status=needs_review" >> $GITHUB_OUTPUT
          fi

      - name: Upload sync report
        uses: actions/upload-artifact@v4
        with:
          name: sync-report
          path: |
            sync-report-*.md
            sync-output.log

      - name: Push if successful
        if: steps.sync.outputs.sync_status == 'success'
        run: |
          git push origin ${{ github.ref_name }}

      - name: Create issue if review needed
        if: steps.sync.outputs.sync_status == 'needs_review'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let syncOutput = '';
            try {
              syncOutput = fs.readFileSync('sync-output.log', 'utf8');
            } catch (e) {
              syncOutput = 'Could not read sync output';
            }

            const reports = fs.readdirSync('.').filter(f => f.startsWith('sync-report-'));
            let reportContent = '';
            if (reports.length > 0) {
              reportContent = fs.readFileSync(reports[reports.length - 1], 'utf8');
            }

            const issueBody = `## DilloBot Upstream Sync Needs Review

            The Claude Code sync agent detected changes that require manual review to preserve security patches.

            ### Sync Output
            \`\`\`
            ${syncOutput.slice(-5000)}
            \`\`\`

            ### Report
            ${reportContent}

            ### Action Required
            1. Review the conflicts listed above
            2. Manually merge ensuring security patches are preserved
            3. Run verification: \`npm run dillobot:verify\`
            4. Close this issue once resolved

            See [SECURITY_PATCHES.md](scripts/sync/SECURITY_PATCHES.md) for required security modifications.
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîí Upstream Sync Needs Manual Review',
              body: issueBody,
              labels: ['sync', 'security', 'needs-review']
            });

  verify-security:
    name: Verify Security Patches
    needs: check-upstream
    # Always verify security patches are intact on the current branch
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify security patches
        run: bash scripts/sync/verify-security.sh

  # Create reminder when upstream has updates
  # Run sync locally with: npm run dillobot:sync
  local-sync-reminder:
    name: Local Sync Reminder
    needs: check-upstream
    if: needs.check-upstream.outputs.has_updates == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Create sync reminder
        uses: actions/github-script@v7
        with:
          script: |
            const commitCount = '${{ needs.check-upstream.outputs.commit_count }}';

            // Check if reminder issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'sync-reminder',
              state: 'open'
            });

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `‚è∞ Reminder: ${commitCount} new commits from upstream OpenClaw.\n\nRun locally:\n\`\`\`bash\ncd /path/to/dillobot\nnpm run dillobot:sync\n\`\`\``
              });
            } else {
              // Create new reminder
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üîÑ Upstream Sync Available (${commitCount} commits)`,
                body: `OpenClaw has ${commitCount} new commits.\n\n## Run Sync Locally\n\n\`\`\`bash\ncd /path/to/dillobot\nnpm run dillobot:sync\n\`\`\`\n\nThis uses your Claude Code subscription to intelligently merge while preserving security patches.\n\n## Or Manual Sync\n\n\`\`\`bash\ngit fetch upstream\ngit merge upstream/main\nnpm run dillobot:verify\n\`\`\``,
                labels: ['sync-reminder']
              });
            }
